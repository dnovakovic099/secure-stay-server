<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Low Occupancy Report</title>
</head>

<body style="font-family: Arial, sans-serif; background-color: #f7f9fc; margin: 0; padding: 0;">
    <table width="100%" cellpadding="0" cellspacing="0" border="0" role="presentation">
        <tr>
            <td align="center">
                <table width="1100" cellpadding="20" cellspacing="0"
                    style="background-color: #ffffff; margin-top: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1);">
                    <tr>
                        <td style="padding: 20px;">
                            <h2 style="margin-top: 0; color: #333; font-size: 24px;">ðŸ“‰ Low Occupancy Report</h2>
                            <p style="font-size: 14px; color: #555; line-height: 20px;">
                                This report highlights properties with occupancy rates below 50% for next 7 days, based
                                on the Hostaway calendar.
                            </p>

                            <% const categories={ own: 'ðŸ  Own Properties' , arbitraged: 'ðŸ’¸ Arbitraged Properties' ,
                                pmClients: 'ðŸ¤ PM Clients' }; %>

                            <% function groupConsecutiveDates(dates) { if (!dates || dates.length===0) return [];
                                const sortedDates=dates.map(d=> new Date(d)).sort((a, b) => a - b);
                                const groups = [];
                                let start = sortedDates[0];
                                let end = start;
                                for (let i = 1; i < sortedDates.length; i++) { const current=sortedDates[i]; const
                                    prev=sortedDates[i - 1]; const diff=(current - prev) / (1000 * 60 * 60 * 24); if
                                    (diff===1) { end=current; } else { groups.push([start, end]); start=current;
                                    end=current; } } groups.push([start, end]); return groups.map(([s, e])=> {
                                    const options = { month: "short", day: "numeric" };
                                    return s.getTime() === e.getTime()
                                    ? s.toLocaleDateString("en-US", options)
                                    : `${s.toLocaleDateString("en-US", options)} to ${e.toLocaleDateString("en-US",
                                    options)}`;
                                    });
                                    } %>

                            <% function getOccupancyStyle(period, value, isFuture) { if (!isFuture) { if
                                (period==="7days" && value < 25) return { color: "#b71c1c" , emoji: "" }; if
                                (period==="14days" && value < 50) return { color: "#d32f2f" , emoji: "" }; if
                                (period==="30days" && value < 60) return { color: "#f57c00" , emoji: "" }; if
                                (period==="90days" && value < 70) return { color: "#fbc02d" , emoji: "" }; } else { if
                                (period==="7days" && value < 50) return { color: "" , emoji: "âš ï¸" }; if
                                (period==="14days" && value < 25) return { color: "" , emoji: "âš ï¸" }; } return { color:
                                "" , emoji: "" }; } %>

                            <% function renderOccupancyTd(period, value, isFuture) { const { color, emoji
                                }=getOccupancyStyle(period, value, isFuture); let
                                style=`text-align: center; padding: 10px; font-size: 14px; border-right: 1px solid #e0e0e0;
                                border-bottom: 1px solid #e0e0e0;`; if (color) { style +=` color: ${color};`; } if
                                (color || emoji) { style +=` font-weight: bold;`; } return `<td style="${style}">${value}%
                                ${emoji || ''}
                            </td>`;
                            } %>

                            <% for (const categoryKey in categories) { const properties=data[categoryKey]; if (properties &&
                                properties.length> 0) { %>

                                <h3
                                    style="color: white; border-bottom: 1px solid #ddd; padding-bottom: 5px; background-color: #b59f6e; padding-left: 5px; padding-top: 2px; font-size: 18px;">
                                    <%= categories[categoryKey] %>
                                </h3>

                                <% properties.forEach(property=> {
                                    const pastNotes = [];
                                    const futureNotes = [];

                                    // NEW: processBlockedDates now returns an array of formatted strings
                                    function processBlockedDatesToStrings(blockedDatesArray) {
                                      const notesMap = new Map();
                                      blockedDatesArray.forEach(item => {
                                        const note = item.note && item.note.trim() !== '' ? item.note : 'No specific reason';
                                        if (!notesMap.has(note)) {
                                          notesMap.set(note, []);
                                        }
                                        notesMap.get(note).push(item.date);
                                      });

                                      const formattedNotes = [];
                                      notesMap.forEach((dates, note) => {
                                        const ranges = groupConsecutiveDates(dates);
                                        const count = dates.length;
                                        const dayLabel = count === 1 ? 'day' : 'days';
                                        const datePart = ranges.join(', ');
                                        const notePart = note && note.trim() !== '' ? ` - ${note}` : '';
                                        formattedNotes.push(`${datePart}${notePart}`);
                                      });
                                      return formattedNotes;
                                    }


                                    // Modified formatNoteLine to handle just owner stay, or general notes
                                    function formatNoteLine(label, dates) {
                                      const ranges = groupConsecutiveDates(dates);
                                      const count = dates.length;
                                      const dayLabel = count === 1 ? 'day' : 'days';
                                      return `${label}: ${count} ${dayLabel} (${ranges.join(', ')})`;
                                    }


                                    if (property.pastRates['30days'].ownerStayDates?.length > 0) {
                                      pastNotes.push(formatNoteLine('Owner Stay', property.pastRates['30days'].ownerStayDates));
                                    }
                                    if (property.pastRates['30days'].blockedDates?.length > 0) {
                                      const blockedStrings = processBlockedDatesToStrings(property.pastRates['30days'].blockedDates);
                                      if (blockedStrings.length > 0) {
                                        const totalBlockedDays = property.pastRates['30days'].blockedDates.length;
                                        const dayLabel = totalBlockedDays === 1 ? 'D' : 'D'; // Using 'D' for single/multiple
                                        pastNotes.push(`Blocked Dates: ${totalBlockedDays}${dayLabel} (${blockedStrings.join(', ')})`);
                                      }
                                    }

                                    if (property.futureRates['30days'].ownerStayDates?.length > 0) {
                                      futureNotes.push(formatNoteLine('Owner Stay', property.futureRates['30days'].ownerStayDates));
                                    }
                                    if (property.futureRates['30days'].blockedDates?.length > 0) {
                                      const blockedStrings = processBlockedDatesToStrings(property.futureRates['30days'].blockedDates);
                                      if (blockedStrings.length > 0) {
                                        const totalBlockedDays = property.futureRates['30days'].blockedDates.length;
                                        const dayLabel = totalBlockedDays === 1 ? 'D' : 'D'; // Using 'D' for single/multiple
                                        futureNotes.push(`Blocked Dates: ${totalBlockedDays}${dayLabel} (${blockedStrings.join(', ')})`);
                                      }
                                    }
                                    %>

                                    <table width="100%" cellpadding="0" cellspacing="0" border="0" role="presentation"
                                        style="margin-bottom: 20px; border: 1px solid #e0e0e0; border-radius: 6px; border-collapse: collapse;">
                                        <tr>
                                            <th
                                                style="width: 200px; min-width: 200px; padding: 10px; text-align: left; background-color: #f3f6f9; border-right: 1px solid #9c9b9b; border-bottom: 1px solid #e0e0e0; font-size: 14px;">
                                                Property</th>
                                            <th
                                                style="width: 100px; padding: 10px; text-align: center; background-color: #f3f6f9; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; font-size: 14px;">
                                                Past 90</th>
                                            <th
                                                style="width: 100px; padding: 10px; text-align: center; background-color: #f3f6f9; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; font-size: 14px;">
                                                Past 30</th>
                                            <th
                                                style="width: 100px; padding: 10px; text-align: center; background-color: #f3f6f9; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; font-size: 14px;">
                                                Past 14</th>
                                            <th
                                                style="width: 100px; padding: 10px; text-align: center; background-color: #f3f6f9; border-bottom: 1px solid #e0e0e0; font-size: 14px;">
                                                Past 7</th>
                                            <th
                                                style="width: 0px; padding: 0; background-color: #9c9b9b; border-bottom: 1px solid #e0e0e0;">
                                            </th>
                                            <th
                                                style="width: 100px; padding: 10px; text-align: center; background-color: #f3f6f9; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; font-size: 14px;">
                                                Next 7</th>
                                            <th
                                                style="width: 100px; padding: 10px; text-align: center; background-color: #f3f6f9; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; font-size: 14px;">
                                                Next 14</th>
                                            <th
                                                style="width: 100px; padding: 10px; text-align: center; background-color: #f3f6f9; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; font-size: 14px;">
                                                Next 30</th>
                                            <th
                                                style="width: 100px; padding: 10px; text-align: center; background-color: #f3f6f9; border-bottom: 1px solid #e0e0e0; font-size: 14px;">
                                                Next 90</th>
                                        </tr>
                                        <tr>
                                            <td
                                                style="width: 200px; min-width: 200px; padding: 10px; vertical-align: top; border-right: 1px solid #9c9b9b; border-bottom: 1px solid #e0e0e0;">
                                                <a href="https://dashboard.hostaway.com/v3/calendar/redirect/monthly/<%= property.listingId %>/<%= property.currentYear %>/<%= property.currentMonth %>"
                                                    target="_blank" style="color: #007bff; text-decoration: none;">
                                                    <%= property.listingName %>
                                                </a>
                                            </td>
                                            <%- renderOccupancyTd('90days', property.pastRates["90days"].occupancyRate,
                                                false) %>
                                                <%- renderOccupancyTd('30days', property.pastRates["30days"].occupancyRate,
                                                    false) %>
                                                    <%- renderOccupancyTd('14days',
                                                        property.pastRates["14days"].occupancyRate, false) %>
                                                        <td
                                                            style="padding: 10px; text-align: center; border-bottom: 1px solid #e0e0e0;">
                                                            <%= property.pastRates["7days"].occupancyRate %>%
                                                        </td>
                                                        <td
                                                            style="width: 1px; padding: 0; background-color: #9c9b9b; border-bottom: 1px solid #e0e0e0;">
                                                        </td>
                                                        <td
                                                            style="padding: 10px; text-align: center; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0;">
                                                            <%= property.futureRates["7days"].occupancyRate %>% <%=
                                                                    getOccupancyStyle('7days',
                                                                    property.futureRates["7days"].occupancyRate, true).emoji
                                                                    || '' %>
                                                        </td>
                                                        <td
                                                            style="padding: 10px; text-align: center; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0;">
                                                            <%= property.futureRates["14days"].occupancyRate %>% <%=
                                                                    getOccupancyStyle('14days',
                                                                    property.futureRates["14days"].occupancyRate,
                                                                    true).emoji || '' %>
                                                        </td>
                                                        <td
                                                            style="padding: 10px; text-align: center; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0;">
                                                            <%= property.futureRates["30days"].occupancyRate %>%
                                                        </td>
                                                        <td
                                                            style="padding: 10px; text-align: center; border-bottom: 1px solid #e0e0e0;">
                                                            <%= property.futureRates["90days"].occupancyRate %>%
                                                        </td>
                                        </tr>
                                        <% if (pastNotes.length> 0 || futureNotes.length > 0) { %>
                                            <tr>
                                                <td
                                                    style="width: 200px; min-width: 200px; padding: 10px; vertical-align: top; border-right: 1px solid #9c9b9b; border-bottom: 1px solid #e0e0e0;">
                                                </td>
                                                <td colspan="4"
                                                    style="font-size: 13px; color: #666; padding: 10px; border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0;">
                                                    <% pastNotes.forEach(line=> { %>
                                                        <div style="line-height: 18px;">
                                                            <%= line %>
                                                        </div>
                                                        <% }) %>
                                                </td>
                                                <td
                                                    style="width: 1px; padding: 0; background-color: #9c9b9b; border-bottom: 1px solid #e0e0e0;">
                                                </td>
                                                <td colspan="4"
                                                    style="font-size: 13px; color: #666; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                                                    <% futureNotes.forEach(line=> { %>
                                                        <div style="line-height: 18px;">
                                                            <%= line %>
                                                        </div>
                                                        <% }) %>
                                                </td>
                                            </tr>
                                            <% } %>
                                                <tr>
                                                    <td colspan="10" style="padding: 0; height: 0; border: none;"></td>
                                                </tr>
                                    </table>

                                    <% }); %>
                                        <% } %>
                                            <% } %>

                                                <p style="font-size: 12px; color: #888; line-height: 18px;">Report generated
                                                    based on current data from the Hostaway calendar.</p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>

</html>